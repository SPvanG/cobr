<!DOCTYPE html>
<meta charset="utf-8">
<style>
body {
    font: 10px Helvetica Neue, sans-serif;
    background: #7f7f7f;
    color:white;
}


</style>
<head>
    <link rel="stylesheet" type="text/css" href="forcelayout.css">
</head>
<body>
    <script src="d3.min.js"></script>
    <script src="jquery-2.1.1.min.js"></script>
    <script src="underscore-min.js"></script>
    <script src="forcelayout.js"></script>

    <div id="filter">
        <form action="index.html" method="get">
            <b>node filter:</b></br>
            <select id="filterBy" name="filterBy"></select>
            
            <select id="filterOp" name="filterOp">
                <option>eq</option>
            </select>
            
            <input type="text" id="filterVal" name="filterVal"></input>

            <input type="submit"></input>
        </form>
    </div>

    <input type="search" id="nodeQuery" style="width:200px;" onkeyup="handle();"></input><br/>

    <div id='forcelayout'></div>

    <script>
    var queryDict = {}
    location.search.substr(1).split("&").forEach(function(item) {queryDict[item.split("=")[0]] = item.split("=")[1]})

    filterpresets = {

    };

    var force;
    var nodes = [];
    var nodesdict = {};
    var links = [];

    $.ajax({
        url: 'http://127.0.0.1:5000/api/mtable',
        data: {
            "q": JSON.stringify({
                "filters": [
                // {
                //     "name": "db_catalog",
                //     "op": "eq",
                //     "val": "X10DBASE"
                // }
                ]
            })
        },
        dataType: "json",
        contentType: "application/json",
        success: function(noderesult) {
            nodes = noderesult.objects;
	    
            // populate a quick lookup dictionary; will come in handy when populating the links
            _.each(nodes, function(node, i) {
                var key = node.db_catalog + "" + node.db_schema + "" + node.tablename;
                nodesdict[key] = {
                    'node': node,
                    'index': i
                };
            });

            $.ajax({
                url: 'http://127.0.0.1:5000/api/mforeignkey',
                data: {
                    "q": JSON.stringify({
                        "filters": [
                                // {
                                //     "name": "comment",
                                //     "op": "eq",
                                //     "val": "csc"
                                // }
                                // , 
                            //     {
                            //         "name": "db_catalog",
                            //         "op": "eq",
                            //         "val": "X10DBASE"
                            //     }
                            ]
                            ,
                            "disjunction": false
                    }
                    )
                },
                dataType: "json",
                contentType: "application/json",
                success: function(linkresult) {
                    links = linkresult.objects;

                    // populate the network using the nodedict and links
                    _.each(links, function(link) {
                        var srcKey = link.db_catalog + "" + link.pkdb_schema + "" + link.pktablename;
                        var tarKey = link.db_catalog + "" + link.fkdb_schema + "" + link.fktablename;

                        var srcNode = nodesdict[srcKey];
                        var tarNode = nodesdict[tarKey];

                        link['source'] = srcNode.index;
                        link['target'] = tarNode.index;
                        link['value'] = 1;

                        // console.log(srcNode.weight)
                        // console.log(tarNode.weight)
                        // console.log('')
                    });

                    force = forcelayout({
                        'parent': '#forcelayout'
                    });

                    force.render({
                        'nodes': nodes,
                        'links': links
                    });
                }
            });
        }
    });

    var handle = function(e) {
        if (!e) e = window.event;

        var keyCode = e.keyCode || e.which;

        if (keyCode == 13) {
            var t = $('#nodeQuery')[0].value.toLowerCase();

            if (t.length <= 0) {
                d3.selectAll('circle').transition().duration(500).style('opacity', 0.75);
                d3.selectAll('line').transition().duration(500).style('opacity', 0.75);
                return;
            }

            d3.selectAll('circle').style('opacity', 0.1);
            d3.selectAll('line').style('opacity', 0.1);

            var re = new RegExp(t);

            for (i in nodesdict) {
                var obj = nodesdict[i];

                if (re.test(obj.tablename.toLowerCase())) {
                    var dnode = d3.select('#node_' + obj.index);

                    dnode
                        .style('opacity', 1)
                        .transition()
                        .duration(250)
                        .attr('r', 30)
                        .transition()
                        .attr('r', nodesizescale(obj.num_rows))
                        .duration(250);
                }
            }

            for (i in linklist) {
                var link = linklist[i];

                if (re.test(link.source.tablename.toLowerCase())) {
                    d3.select('#' + link.id).style('opacity', 1);
                }
                if (re.test(link.target.tablename.toLowerCase())) {
                    d3.select('#' + link.id).style('opacity', 1);
                }
            }
        } else if (keyCode == 27) {
            d3.selectAll('circle').transition().duration(500).style('opacity', 0.75);
            d3.selectAll('line').transition().duration(500).style('opacity', 0.75);
        }
    }

     window.onload = function(){
        var select = document.getElementById("filterBy");
            var options = ['db_catalog', 'comment', 'db_schema', 'tags'];
            for (var i = 0; i < options.length; i++) {
                var opt = options[i];
                var el = document.createElement("option");
                el.textContent = opt;
                el.value = opt;
                select.appendChild(el);
            }
        }
    </script>

</body>
